apiVersion: v1
kind: ConfigMap
metadata:
  name: nifi-ssl-cm
data:
  security.sh: |
    #!/bin/bash
    set -ex -o allexport

    ORGANISATION_UNIT=${ORGANISATION_UNIT:-'Cloud Services Application'}
    ORGANISATION=${ORGANISATION:-'Cloud Services'}
    PUBLIC_DNS=${NIFI_CLUSTER_NODE_ADDRESS:-'nifi.tld'}
    CITY=${CITY:-'London'}
    STATE=${STATE:-'London'}
    COUNTRY_CODE=${COUNTRY_CODE:-'GB'}
    KEY_PASS=${NIFI_SENSITIVE_PROPS_KEY:-$KEYSTORE_PASS}
    KEYSTORE_PASS=${KEYSTORE_PASS:-$NIFI_SENSITIVE_PROPS_KEY}
    KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD:-$NIFI_SENSITIVE_PROPS_KEY}
    KEYSTORE_PATH=${NIFI_HOME}/keytool/keystore.p12
    KEYSTORE_TYPE=pkcs12
    TRUSTSTORE_PASS=${TRUSTSTORE_PASSWORD:-$NIFI_SENSITIVE_PROPS_KEY}
    TRUSTSTORE_PASSWORD=${TRUSTSTORE_PASSWORD:-$NIFI_SENSITIVE_PROPS_KEY}
    TRUSTSTORE_PATH=${NIFI_HOME}/keytool/truststore.p12
    TRUSTSTORE_TYPE=pkcs12

    if [[ ! -f "${NIFI_HOME}/keytool/keystore.p12" ]]
    then
      echo "Creating keystore"
      keytool -genkey -noprompt -alias nifi-keystore \
      -dname "CN=${NIFI_CLUSTER_NODE_ADDRESS},OU=${ORGANISATION_UNIT},O=${ORGANISATION},L=${CITY},S=${STATE},C=${COUNTRY_CODE}" \
      -keystore ${KEYSTORE_PATH} \
      -storepass "${KEYSTORE_PASS:-$NIFI_SENSITIVE_PROPS_KEY}" \
      -keysize 2048 \
      -keypass "${KEY_PASS:-$NIFI_SENSITIVE_PROPS_KEY}" \
      -keyalg RSA \
      -ext "SAN=ip:${POD_IP},dns:localhost,dns:${NIFI_CLUSTER_NODE_ADDRESS},dns:${NIFI_LOAD_BALANCER},dns:${PUBLIC_DNS},ip:127.0.0.1,dns:${NIFI_WEB_HTTP_HOST},dns:${POD_NAME},dns:${NODE_IDENTITY}" \
      -storetype pkcs12

      echo "Exporting the self-signed certificate from the keystore"
      keytool -export -alias nifi-keystore \
      -keystore "${KEYSTORE_PATH}" \
      -storepass "${KEYSTORE_PASS}" \
      -file "${NIFI_HOME}/keytool/nifi-cert.cer" \
      -storetype pkcs12 \
      -rfc
    fi

    if [[ ! -f "${NIFI_HOME}/keytool/truststore.p12" ]]
    then
      echo "Delete if truststore exists"
      keytool -delete -alias nifi-truststore \
      -keystore "${TRUSTSTORE_PATH}" \
      -storepass "${TRUSTSTORE_PASS}" 2>/dev/null || true

      echo "Importing truststore"
      keytool -import -noprompt -alias nifi-truststore \
      -file "${NIFI_HOME}/keytool/nifi-cert.cer" \
      -keystore "${TRUSTSTORE_PATH}" \
      -storetype "${TRUSTSTORE_TYPE}" \
      -storepass "${TRUSTSTORE_PASS}" \
      -trustcacerts
    fi

    #/usr/bin/bash ${NIFI_HOME}/../scripts/secure.sh 
    # eval ${NIFI_HOME}/../scripts/secure.sh
