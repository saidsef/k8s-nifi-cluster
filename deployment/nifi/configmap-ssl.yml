apiVersion: v1
kind: ConfigMap
metadata:
  name: nifi-ssl-cm
data:
  security.sh: |
    #!/bin/bash
    set -ex -o allexport

    NIFI_HOME=${NIFI_HOME:-/opt/nifi/nifi-current}
    ORGANISATION_UNIT=${ORGANISATION_UNIT:-'Cloud Services Application'}
    ORGANISATION=${ORGANISATION:-'Cloud Services'}
    PUBLIC_DNS=${NIFI_CLUSTER_NODE_ADDRESS:-'nifi.tld'}
    CITY=${CITY:-'London'}
    STATE=${STATE:-'London'}
    COUNTRY_CODE=${COUNTRY_CODE:-'GB'}
    KEYSTORE_PASS=${KEYSTORE_PASS:-$NIFI_SENSITIVE_PROPS_KEY}
    KEY_PASS=${KEY_PASS:-$KEYSTORE_PASS}
    KEYSTORE_PATH=${NIFI_HOME}/keytool/keystore.p12
    KEYSTORE_TYPE=pkcs12
    TRUSTSTORE_PASS=${TRUSTSTORE_PASS:-$NIFI_SENSITIVE_PROPS_KEY}
    TRUSTSTORE_PATH=${NIFI_HOME}/keytool/truststore.p12
    TRUSTSTORE_TYPE=pkcs12

    if [[ ! -f "${KEYSTORE_PATH}" ]]
    then
      echo "Creating keystore"
      
      # Build SAN string carefully to avoid empty entries
      SAN="ip:${POD_IP},dns:localhost,ip:127.0.0.1"
      if [[ -n "${NIFI_CLUSTER_NODE_ADDRESS}" ]]; then SAN="${SAN},dns:${NIFI_CLUSTER_NODE_ADDRESS}"; fi
      if [[ -n "${NIFI_LOAD_BALANCER}" ]]; then SAN="${SAN},dns:${NIFI_LOAD_BALANCER}"; fi
      if [[ -n "${PUBLIC_DNS}" ]]; then SAN="${SAN},dns:${PUBLIC_DNS}"; fi
      if [[ -n "${NIFI_WEB_HTTP_HOST}" ]]; then SAN="${SAN},dns:${NIFI_WEB_HTTP_HOST}"; fi
      if [[ -n "${POD_NAME}" ]]; then SAN="${SAN},dns:${POD_NAME}"; fi
      if [[ -n "${NODE_IDENTITY}" ]]; then SAN="${SAN},dns:${NODE_IDENTITY}"; fi

      keytool -genkey -noprompt -alias nifi-keystore \
      -dname "CN=${NIFI_CLUSTER_NODE_ADDRESS},OU=${ORGANISATION_UNIT},O=${ORGANISATION},L=${CITY},S=${STATE},C=${COUNTRY_CODE}" \
      -keystore "${KEYSTORE_PATH}" \
      -storepass "${KEYSTORE_PASS}" \
      -keysize 2048 \
      -keypass "${KEY_PASS}" \
      -keyalg RSA \
      -ext "SAN=${SAN}" \
      -storetype pkcs12

      echo "Exporting the self-signed certificate from the keystore"
      keytool -export -alias nifi-keystore \
      -keystore "${KEYSTORE_PATH}" \
      -storepass "${KEYSTORE_PASS}" \
      -file "${NIFI_HOME}/keytool/nifi-cert.cer" \
      -storetype pkcs12 \
      -rfc
    fi

    if [[ ! -f "${TRUSTSTORE_PATH}" ]]
    then
      echo "Importing truststore"
      keytool -import -noprompt -alias nifi-truststore \
      -file "${NIFI_HOME}/keytool/nifi-cert.cer" \
      -keystore "${TRUSTSTORE_PATH}" \
      -storetype "${TRUSTSTORE_TYPE}" \
      -storepass "${TRUSTSTORE_PASS}" \
      -trustcacerts
    fi